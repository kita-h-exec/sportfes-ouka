# 引継ぎ資料（超・やさしいけど実務で使える版）

---

## 目次
- はじめに（このサイトは何で動いている？）
- 必要な道具をそろえる（インストール）
- プロジェクトの地図（フォルダ構成と役割）
- 動かしてみよう（開発サーバー）
- 公開の仕方（ビルドとデプロイの考え方）
- 設定ファイル（.env）と環境変数
- PWAと通知（Web Push）の仕組みと設定
- データ連携（Directus）とは？
- AI連携（/ai ページ）の仕組み
- よく変える場所（文言変更、画像差し替え、ページ追加）
- Gitの使い方（最低限）
- トラブル対応（チェックリスト付き）
- 学校祭向けの変更例（手順書）
- 用語集（かんたん解説）

---

## はじめに（このサイトは何で動いている？）
- このサイトは「Next.js」という仕組みで作られています。かんたんに言うと「速くて便利なウェブサイトを作るための道具箱」です。
- プログラムの言語は TypeScript（JavaScriptの安全版）です。
- TypeScriptはHTML/CSS/JSの知識の上に乗っかっている言語です。
- 見た目の部品は React という仕組みを使って組み立てています。
- データ（お知らせ、コンテンツ、スケジュール）は Directus という「クラウド上のデータベース」に置くことができます（環境によりオン/オフ）。
- スマホにインストールしたアプリみたいに使える PWA(Progressive Web App)、スマホに通知を送る Web Push に対応しています。

---

## 必要な道具をそろえる（インストール）
Windows での手順です。PowerShell を使います。

1) Node.js を入れる（プログラムを動かすエンジン）
- 配布サイト: https://nodejs.org/
- LTS（安定版）を選んでインストール。再起動は不要です。

2) Git を入れる（変更履歴のノート）
- 配布サイト: https://git-scm.com/
- 基本は「次へ」を押していけばOKです。

3) VS Code を入れる（コード用の高機能メモ帳）
- 配布サイト: https://code.visualstudio.com/

4) プロジェクトを手元にコピーする
- PowerShell を開いて、置きたいフォルダに移動してから実行します。
```powershell
git clone https://github.com/raayucorp/sportfes-test.git
cd sportfes-test
```

5) 必要な部品（ライブラリ）を入れる
```powershell
npm install
```
※ 途中で赤い文字が出ても、最後に「added ○ packages」などが出ていれば大体OKです。

---

## プロジェクトの地図（フォルダ構成と役割）
主な場所だけ覚えればOKです。
- `app/` … ページやAPIの入口。URLに直結します。
  - `app/page.tsx` … トップページ。
  - `app/announcements/page.tsx` … お知らせ一覧。
  - `app/api/.../route.ts` … APIの入口（機能の裏側）。
- `components/` … 見た目の部品（ボタン、ヘッダーなど）。
  - `components/EnableNotifications.tsx` … 通知のONボタン。
- `lib/` … 裏方の便利関数。
  - `lib/directus.ts` … Directus（データベース）とのやりとり。
  - `lib/pushStore.ts` … 通知の登録情報の保存先（メモリ/ファイル/Directus）。
  - `lib/webpush.ts` … 通知を送るための設定。
- `public/` … 画像やアイコン、`sw.js`（通知の受け取り役）など、外から直接見えるファイル。
- `data/` … 通知の登録情報をファイル保存するときに使う場所（`push_subscriptions.json`）。

---

## 動かしてみよう（開発サーバー）
プロジェクトのフォルダ（`sportfes-test`）で、PowerShell から次を実行：
```powershell
npm run dev
```
- ブラウザで http://localhost:3000 を開くとサイトが見られます。
- 画面を直すと自動で反映されます（数秒かかることもあります）。

止めるときは、PowerShell の画面で `Ctrl + C` を押して `Y` を入力します。

---

## 公開の仕方（ビルドとデプロイの考え方）
- ビルド = 本番公開用にファイルをまとめて、速く安全にする作業。
- デプロイ = まとまったファイルをサーバー（インターネットに繋がった場所）へ上げる作業。

ビルドは以下です：
```powershell
npm run build
```
ローカルで本番モードの動作確認をするなら：
```powershell
npm run start
```

## 設定ファイル（.env）と環境変数
このプロジェクトは、秘密情報や接続先を「環境変数」で切り替えます。プロジェクト直下に `.env.local` を作り、必要な行を入れます（Gitに上げない）。

最低限よく使うもの：
- `NEXT_PUBLIC_DIRECTUS_URL` … Directus のURL（例: `https://example.directus.app`）
- `DIRECTUS_STATIC_TOKEN` … 認証トークン（必要な場合のみ）
- `WEB_PUSH_PUBLIC_KEY` / `WEB_PUSH_PRIVATE_KEY` … Web Push の鍵（後述の作り方参照）
- `WEB_PUSH_CONTACT` … 管理者の連絡先（例: `mailto:REDACTED_EMAIL`）
- `PUSH_STORE` … 通知の保存先。`memory`（標準）/`file`/`directus`
- `PUSH_FILE_PATH` … `file` を選んだときの保存先（例: `data/push_subscriptions.json`）
- `NOTIFY_SECRET` … 通知送信用APIの合言葉（後述）。
- `GOOGLE_API_KEY` / `GEMINI_MODEL_NAME` … /ai 機能（任意）で使う鍵。

後で `.env.example` も同梱します（各値の例つき）。

---

## PWAと通知（Web Push）の仕組みと設定
ざっくり言うと：
- `public/manifest.webmanifest` と `public/sw.js` が、サイトを「アプリっぽく」し、通知を受け取る役です。
- 画面側の `components/EnableNotifications.tsx` のボタンを押すと、通知の許可→端末の登録が行われ、バックエンドに保存されます。
- 運営側は `/api/push/send` にリクエストすると、登録された端末へ通知を送れます。

必要な設定：
1) VAPID鍵（通知に必要な鍵）を作る
   - 後述の「付録: VAPID鍵の作り方」を参照して、`.env.local` に設定します。
2) `.env.local` を設定
```dotenv
WEB_PUSH_PUBLIC_KEY=...（作った公開鍵）
WEB_PUSH_PRIVATE_KEY=...（作った秘密鍵）
WEB_PUSH_CONTACT=mailto:you@example.com
PUSH_STORE=file
PUSH_FILE_PATH=data/push_subscriptions.json
NOTIFY_SECRET=お好きな長いランダム文字列
```
3) 通知の登録を試す
   - 開発サーバーを起動して、トップなどにある「プッシュ通知 有効にする」ボタンを押す。
   - ブラウザの権限ダイアログで「許可」を選ぶ。
   - `data/push_subscriptions.json` に登録が増えていればOK。
4) 通知を送る
   - 運営側から PowerShell などでHTTPリクエストを送ります（例）
```powershell
# Windows PowerShell 例（Invoke-WebRequest）
Invoke-WebRequest -Uri "http://localhost:3000/api/push/send" -Method POST -Headers @{"x-notify-secret"="<NOTIFY_SECRET>"; "Content-Type"="application/json"} -Body '{"title":"お知らせ","body":"まもなく開会式です","url":"/announcements"}'
```
   - 成功すると `{ ok: true, sent: 数 }` が返ります。

iOSの注意：
- iPhone/iPad は「ホーム画面に追加」して、そこから開いたときだけ Web Push が使えます。
- `EnableNotifications.tsx` に手順の案内が出るようになっています。

---

## データ連携（Directus）とは？
- Directus は「ノーコードで使えるデータベース＋API」です。表にデータを入れると、Web API で読み出せます。
- `lib/directus.ts` が接続の窓口で、`NEXT_PUBLIC_DIRECTUS_URL` を使います。
- 認証が必要な環境では `DIRECTUS_STATIC_TOKEN` を入れると取りやすくなります（公開権限の設定が無い場合の保険）。
- 例：お知らせの取得は `getAnnouncements()`、ヘッダ用は `getHeaderAnnouncement()`、コンテンツ一覧は `getContents()`、スケジュールは `getSchedules()`。
- これらは `app/api/.../route.ts` からも利用され、フロントエンドは `/api/...` を叩きます。

### Directus をローカルで起動する（Windows）
Directus は Docker（アプリを入れた箱）で簡単に起動できます。
1) Docker Desktop をインストール
   - https://www.docker.com/products/docker-desktop/ からインストール。
   - インストール後、Docker Desktop を起動した状態にします。
2) プロジェクトの `directus/` に移動して起動
```powershell
cd directus
# 初回はイメージ(設計図)のダウンロードが走るため数分かかります
docker compose up -d
```
3) 管理画面にアクセス
   - ブラウザで http://localhost:8055 を開く。
   - 最初の起動時、管理者ユーザーが自動作成されます（`docker-compose.yml` の `ADMIN_EMAIL`/`ADMIN_PASSWORD`）。
   - ログインできたら成功です。
4) 止めたいとき
```powershell
docker compose stop
```
   - コンテナとデータを掃除したい（最初からやり直し）場合は：
```powershell
docker compose down -v
```
   - この操作はDBやアップロードの中身も消えるので注意。

### Next.js 側との接続設定
1) `.env.local` にDirectusのURLを設定
```dotenv
NEXT_PUBLIC_DIRECTUS_URL=http://localhost:8055
```
2) 公開権限がない/ログインしないと取れない項目がある場合は静的トークンを設定
   - Directus 管理画面 → 設定（Settings）→ 「Users & Roles」→ 「Roles」→ 読み取りさせたい権限（例：Public）を開いて、対象コレクションの Read をON。
   - トークンで読む場合は、「Users」から専用ユーザーを作成し、Settings → Access Tokens（Personal Tokens/Static Tokens）等で読み取り用トークンを発行し、`.env.local` に設定：
```dotenv
DIRECTUS_STATIC_TOKEN=＜発行したトークン＞
DIRECTUS_ALLOW_TOKEN_FALLBACK=1
```
   - `lib/directus.ts` は権限エラー時にフィールドを減らして再試行する安全策があり、`DIRECTUS_ALLOW_TOKEN_FALLBACK=1` でトークン失敗時に Public へ自動フォールバックします。

### 接続確認（ヘルスチェック）
- Directus自体の稼働確認: `http://localhost:8055/server/health` をブラウザで開いて200ならOK。
- 本プロジェクトのデバッグAPI: `/api/debug/directus/status`
  - 例: http://localhost:3000/api/debug/directus/status
  - 設定したURL/トークン、Directusのヘルス、`announcements` を1件読めるかの簡易結果を返します。

### 最小スキーマ（コレクション）例
運用を始める最小構成の目安です。Directus 管理画面の「Data Model」から作成してください。
- announcements（お知らせ）
  - title (string) 必須
  - body (text) 任意
  - status (string) 例: "published" / "archived"
  - show_in_header (boolean)
  - date_created (datetime) 自動
  - date_updated (datetime) 自動
- contents（リンク集）
  - title (string) or name (string)
  - description (text)
  - href (string) or url (string) or slug (string)
  - icon (string) 任意
  - sort (integer) 任意
  - status (string) 任意
- schedules（スケジュール）
  - start_time (datetime)
  - end_time (datetime) 任意
  - event (string) or title (string)
  - description (text) 任意
  - is_all_day (boolean) 任意
- blocks（ブロック）
  - slug (string) 主キー相当
  - name (string)
  - color (string)
  - text_color (string)
  - section_1_title/description (string/text)
  - section_2_title/description (string/text)
- emergency（一斉案内）
  - message (text)
  - display (boolean)

権限（Roles）で、Public もしくは配布トークンのロールに対して、上記コレクションの Read を許可してください。不要なWriteはオフにすると安全です。

### 権限（Roles）とトークン（Static Token）の設定手順（かんたん）
Directusでは、どのユーザー（ロール）がどのコレクションを読めるかを細かく決められます。

1) Public（未ログイン）で読ませたい場合
- 管理画面 → Settings → Users & Roles → Roles → 「Public」を選択
- 「Permissions」タブで、読みたいコレクション（announcements, contents, schedules, blocks, emergency）を選択
- Action で「read」をON（filterは最初は空でOK、必要に応じて公開条件を加える）
- 保存（Save）

2) トークンで読ませたい場合（より安全）
- 管理画面 → Users → Add User（読み取り専用ユーザーを作成）
  - ロールは読み取り用のRole（例: Reader）を作るか、既存のロールを選択
- 管理画面 → Settings → Access Tokens（Personal/Static Tokens）
  - 新規作成して「読み取りユーザー」に紐づけ、トークン文字列を発行
- `.env.local` に設定：
```dotenv
DIRECTUS_STATIC_TOKEN=（発行されたトークン）
DIRECTUS_ALLOW_TOKEN_FALLBACK=1
```
- これでフロント/APIはトークンで取得を試み、失敗時はPublicへ自動フォールバック（`lib/directus.ts`の安全策）

3) CORSとPUBLIC_URL（必要に応じて）
- 外部ドメインからDirectus APIを呼ぶ場合は、`CORS_ORIGIN` に呼び出し元のOriginを設定（開発中は `*` でも可、本番は絞る）
- 共有リンクやWebhookで生成されるURLの基準は `PUBLIC_URL`（docker-compose 既定: `http://localhost:8055`）

### 最小スキーマをUIで作る手順（例）
以下は「announcements」を作る流れの例です（他のコレクションも同様）。
1) 管理画面 → Data Model → 「Create Collection」
- Collection Name: `announcements`
- Primary Key: `uuid` か `integer`（お好み）
2) Fields を追加
- `title`（Type: String, Required: ON）
- `body`（Type: Text）
- `status`（Type: String, Default: `published` など）
- `show_in_header`（Type: Boolean, Default: false）
- 監査系はDirectusの自動フィールド（`date_created`/`date_updated`）を利用
3) 保存
4) RolesのPermissionsでPublicまたはReaderロールに `read` を許可

推奨の補足設定
- `blocks.slug` は Unique にする（重複禁止）
- `contents.sort` は Number（Integer）。未設定は null でもOK
- `schedules.start_time/end_time` は DateTime（タイムゾーンの扱いに注意）

### Docker間移行（サーバー引っ越し）手順（directus-backup.sh を利用）
このリポジトリの `directus/directus-backup.sh` は、DBとuploads/extensionsをまとめてバックアップ/復元できます。Windowsでは Git Bash または WSL での実行を推奨します。

前提
- 旧サーバー・新サーバーともに Docker / Docker Compose v2 が使える
- `directus/docker-compose.yml` は新旧で基本同一（DB名/ユーザー/ボリューム名などが一致していること）
- Directus の `KEY`/`SECRET`/`ADMIN_*` は移行後に再生成されても構いませんが、Webhookや外部連携がある場合は合わせるのが安全

1) 旧サーバーでバックアップ
```bash
cd directus
chmod +x directus-backup.sh
MODE=backup ./directus-backup.sh
```
- `directus/backups/日時/` に `db.dump` / `uploads.tgz` / `extensions.tgz` などが生成されます

2) 生成フォルダを新サーバーへコピー
- `scp` や `rsync` で `directus/backups/日時/` 配下を転送

3) 新サーバーでDirectusスタックを起動
```bash
cd directus
docker compose up -d
```

4) 復元を実行
```bash
# 例: 最新バックアップを使う場合は list してパスを確認
./directus-backup.sh   # 対話メニューで restore を選び、対象パスを指定
# もしくは非対話
MODE=restore TARGET=backups/20250101-120000 ./directus-backup.sh
```

5) 動作確認
- http://<新サーバーのホスト>:8055 でログイン
- フロントエンド `.env.local` の `NEXT_PUBLIC_DIRECTUS_URL` を新サーバーのURLへ更新
- `/api/debug/directus/status` で疎通確認

注意
- `docker compose down -v` はボリュームも削除するため、必ずバックアップ取得後に実施
- Directusのメジャーバージョン差が大きい場合は、最初に旧環境を同バージョンへ合わせてから移行するのが安全（`directus/directus:<version>` など固定）

---

## 用語集（かんたん解説・拡張）
- API … アプリ同士がデータのやり取りをするための約束事。レストランの「注文用窓口」のイメージ。
- エンドポイント … APIの住所（URL）。例: `/api/contents`。
- Docker … アプリを入れる「標準化された箱」。どのPCでも同じ手順で動かしやすい。
- コンテナ … Dockerの箱そのもの。実際に動いているインスタンス。
- イメージ … コンテナを作る設計図。`directus/directus:latest` など。
- ボリューム … データを保存する場所。コンテナを消しても中身が残る（DBやアップロードを守る）。
- PostgreSQL … データベースの一種。Directusの保存先に使います。
- Redis … 高速なメモリキャッシュ。Directusの高速化に使うことがあります。
- CORS … 別のサイトからAPIを叩くときの許可ルール。`CORS_ORIGIN="*"` は開発では便利、本番では適切に絞る。
- 権限（Permissions）… 誰（どのロール）が、どのデータに、どんな操作（読む/書く）をしてよいかのルール
- ロール（Roles）… 権限のセット。例：Public（未ログイン）、Editor（編集者）
- トークン（Token）… パスワードの代わりに使える合言葉。長い文字列をHTTPヘッダに付けてAPIにアクセス
- ヘルスチェック（/server/health）… サービスが生きているかの簡易確認用URL
- フォールバック（Fallback）… うまくいかなかった時に次の方法へ自動で切り替えること
- マイグレーション（Migration）… データやシステムを別の環境へ移すこと（引っ越し）

---

## 付録: .env.example（例）
以下を `./.env.example` としても用意しておくと便利です（実値は `.env.local` に記入）。

```dotenv
# Directus（任意）
NEXT_PUBLIC_DIRECTUS_URL=https://example.directus.app
DIRECTUS_STATIC_TOKEN=

# Web Push（通知）
WEB_PUSH_PUBLIC_KEY=
WEB_PUSH_PRIVATE_KEY=
WEB_PUSH_CONTACT=mailto:you@example.com
PUSH_STORE=file
PUSH_FILE_PATH=data/push_subscriptions.json
NOTIFY_SECRET=change-me-long-random

# AI（任意）
GOOGLE_API_KEY=
GEMINI_MODEL_NAME=gemini-2.5-flash
```

---

## 付録: VAPID鍵の作り方
`web-push` というツールで作れます。
1) 一度だけセットアップ
```powershell
npm exec web-push generate-vapid-keys --silent
```
2) 実行すると、`Public Key`（公開鍵）と `Private Key`（秘密鍵）が表示されます。これを `.env.local` にコピペします。

もし上のコマンドが見つからない場合は次を試してください：
```powershell
npm install web-push --save-dev
npx web-push generate-vapid-keys --silent
```

---

## 最後に（チェックリスト）
- [ ] `npm install` が成功
- [ ] `.env.local` を作成
- [ ] `npm run dev` で http://localhost:3000 が表示
- [ ] 通知の有効化ができる（許可ダイアログ→OK）
- [ ] `api/push/send` で通知が届く
- [ ] Directus のURLと権限を確認（必要な場合）
- [ ] 画像・文言を学校祭向けに変更
- [ ] Git で変更を保存・共有

この資料に沿って作業すれば、「見る・直す・配る」の基本ができるはずです。わからない点があれば、エラーメッセージと一緒にチームへ共有してください。