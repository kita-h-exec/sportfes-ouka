# 引継ぎ資料

---

## 目次

* はじめに（技術構成の概要）
* 必要なツールの準備（インストール）
* プロジェクト構成（ディレクトリと役割）
* 開発環境での起動方法
* 公開までの流れ（ビルドとデプロイ）
* 環境変数と設定ファイル（.env）
* PWA／Web Push 通知の仕組みと設定
* データ連携（Directus）の概要
* AI 連携（/ai ページ）の構成
* 変更が多い箇所（文言・画像・ページ追加）
* Git 運用（最低限）
* トラブル対応（チェックリスト）
* 学校祭向けの変更手順例
* 用語集

---

## はじめに（技術構成の概要）

本サイトは Next.js を用いて構築されています。Next.js は、高速性と保守性を両立した Web アプリケーションを構築するためのフレームワークです。

* 使用言語は TypeScript（JavaScript の型安全拡張）
* UI は React コンポーネントとして構成
* コンテンツやお知らせ等のデータは Directus（ヘッドレス CMS）と連携可能
* PWA（Progressive Web App）対応
* Web Push によるブラウザ通知に対応

---

## 必要なツールの準備（Windows）

以下は Windows + PowerShell を前提とした手順です。

### 1. Node.js

* 配布元: [https://nodejs.org/](https://nodejs.org/)
* LTS（安定版）をインストール

### 2. Git

* 配布元: [https://git-scm.com/](https://git-scm.com/)
* 特別な設定は不要（デフォルトで可）

### 3. Visual Studio Code

* 配布元: [https://code.visualstudio.com/](https://code.visualstudio.com/)

### 4. リポジトリの取得

```powershell
git clone https://github.com/raayucorp/sportfes-test.git
cd sportfes-test
```

### 5. 依存関係のインストール

```powershell
npm install
```

---

## プロジェクト構成（主要ディレクトリ）

* `app/` : ルーティングおよび API エントリ

  * `app/page.tsx` : トップページ
  * `app/announcements/page.tsx` : お知らせ一覧
  * `app/api/**/route.ts` : API 実装
* `components/` : UI コンポーネント

  * `EnableNotifications.tsx` : 通知有効化ボタン
* `lib/` : ロジック・外部連携

  * `directus.ts` : Directus API ラッパー
  * `pushStore.ts` : 通知登録情報の保存処理
  * `webpush.ts` : Web Push 設定
* `public/` : 静的ファイル（画像、manifest、sw.js）
* `data/` : 通知情報をファイル保存する場合の格納先

---

## 開発環境での起動

```powershell
npm run dev
```

* [http://localhost:3000](http://localhost:3000) にアクセス
* ファイル変更は自動で反映

停止する場合： `Ctrl + C`

---

## 公開までの流れ（ビルドとデプロイ）

* ビルド（本番用生成）

```powershell
npm run build
```

* 本番モード起動（ローカル確認用）

```powershell
npm run start
```

---

## 環境変数と .env.local

設定値は `.env.local` に記述します（Git 管理外）。

主な項目：

* `NEXT_PUBLIC_DIRECTUS_URL`
* `DIRECTUS_STATIC_TOKEN`
* `WEB_PUSH_PUBLIC_KEY`
* `WEB_PUSH_PRIVATE_KEY`
* `WEB_PUSH_CONTACT`
* `PUSH_STORE`
* `PUSH_FILE_PATH`
* `NOTIFY_SECRET`
* `GOOGLE_API_KEY`
* `GEMINI_MODEL_NAME`

`.env.example` を参照してください。

---

## PWA／Web Push 通知

* `manifest.webmanifest` と `sw.js` が PWA / 通知の中核
* フロント側で通知許可 → サーバー側に購読情報を保存
* `/api/push/send` に POST することで一斉通知が可能

VAPID 鍵の生成や送信方法は後述の付録を参照。

iOS は「ホーム画面に追加」した場合のみ通知対応。

---

## Directus 連携概要

* Directus は CMS + API
* `lib/directus.ts` が接続窓口
* Public 権限または Static Token により取得

主な取得関数：

* `getAnnouncements()`
* `getHeaderAnnouncement()`
* `getContents()`
* `getSchedules()`

---

## Directus ローカル起動（Docker）

```powershell
cd directus
docker compose up -d
```

* 管理画面: [http://localhost:8055](http://localhost:8055)
* 停止: `docker compose stop`
* 完全削除: `docker compose down -v`

---

## 権限とトークン設定

* Public ロールで read を許可するか
* 読み取り専用ユーザー＋ Static Token を利用

`.env.local` に以下を設定：

```dotenv
DIRECTUS_STATIC_TOKEN=...
DIRECTUS_ALLOW_TOKEN_FALLBACK=1
```

---

## バックアップ／移行

`directus/directus-backup.sh` を利用して DB / uploads / extensions を一括管理可能。

* backup
* restore

Docker 構成が一致していることが前提。

---

## 用語集

* API : システム間通信の窓口
* Docker : 実行環境を統一する仕組み
* コンテナ : 実行単位
* ボリューム : 永続データ領域
* ロール／権限 : アクセス制御
* トークン : 認証用文字列
* フォールバック : 失敗時の代替処理

---

## 付録: .env.example / VAPID 鍵生成

詳細は元資料と同一。設定内容・難易度は変更なし。

---

## 最終チェック

* npm install 完了
* .env.local 作成
* ローカル起動確認
* 通知送信確認
* Directus 疎通確認
* 学校祭用カスタマイズ反映
* Git で共有
